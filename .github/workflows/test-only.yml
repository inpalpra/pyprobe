name: Test Only

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Manual dispatch for targeted debugging
  workflow_dispatch:
    inputs:
      test_pattern:
        description: 'Pytest pattern or file to run (leave empty for full suite)'
        required: false
        default: ''
      extra_args:
        description: 'Extra arguments to pass to pytest'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install Linux display dependencies (for Qt/GUI tests)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libegl1 libgl1 libglib2.0-0 \
            libxcb-cursor0 libxcb-icccm4 libxcb-image0 \
            libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 \
            libxcb-shape0 libxcb-xfixes0 libxcb-xinerama0 \
            libxcb-xkb1 libxkbcommon-x11-0 \
            xvfb

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          uv venv /tmp/test-env
          uv pip install --python /tmp/test-env .
          uv pip install --python /tmp/test-env \
            pytest-qt \
            pytest-xdist \
            pytest-forked \
            pytest-json-report \
            pytest-profiling \
            pytest-html \
            pytest-metadata

      - name: Run tests
        run: |
          # Tolerate exit-139 (SIGSEGV during Qt/C++ cleanup at process exit).
          # This is cosmetic — all tests have already passed by that point.
          set +e
          if [ -n "${{ github.event.inputs.test_pattern }}" ]; then
            # Targeted run via workflow_dispatch
            xvfb-run --auto-servernum \
              /tmp/test-env/bin/python -m pytest -s -v --tb=long \
                ${{ github.event.inputs.test_pattern }} \
                ${{ github.event.inputs.extra_args }}
          else
            # Full suite — slow/flaky tests ignored; their _fast variants run.
            # Keep this list in sync with release.yml.
            xvfb-run --auto-servernum \
              /tmp/test-env/bin/python -m pytest tests/ -v --tb=short \
                --ignore=tests/gui/test_script_runner_subprocess.py \
                --ignore=tests/test_cli_automation.py \
                --ignore=tests/ipc/test_socket_channel.py \
                ${{ github.event.inputs.extra_args }}
          fi
          rc=$?
          set -e
          if [ $rc -eq 139 ]; then
            echo "⚠ SIGSEGV during Qt cleanup (cosmetic, exit 139) — tests passed."
            exit 0
          fi
          exit $rc


