# Milestone 5 — ReportBugDialog + Help Menu (MVP)

## Overview

This milestone integrates all prior pure-logic modules (M1–M4) into a working,
end-to-end bug report flow inside the application:

1. A **Help** menu is added to `MainWindow` with a **Report Bug** action.
2. `ReportBugDialog` (a `QDialog` subclass) provides the complete UI from the spec,
   minus recording controls (those come in M7).
3. "Generate Report" assembles a `BugReport` from live session state and renders it.
4. Two output actions are provided: **Copy to Clipboard** and **Save to File**.

GUI tests in this milestone use `pytest-qt`. Tests protect behavioral flow and
conditional output — not exact widget labels or strict widget tree structure.

---

## Guiding Principles

- **Tests first, implementation second.** Write all tests listed below, confirm every
  one is **failing**, then implement. Never write implementation before tests exist.
- **Zero regression tolerance.** `python run_tests.py` must be fully green at the end
  of this milestone. No existing tests (including M1–M4's) may break.
- **Behavior-focused GUI tests.** Tests assert what the dialog *does* — opens, generates,
  populates clipboard, toggles sections — not which widget class or exact label string
  is used. This leaves room to improve the UI without rewriting tests.
- **Sanitization is always on.** Any home-directory path that enters the report through
  any channel must be absent from the generated output.
- **Permanent regression suite.** Every test here is a permanent guard for all future
  milestones and future development.

---

## Goal

Implement:

1. **Help menu** in `MainWindow` with a Report Bug action.
2. **`ReportBugDialog`** with:
   - A text area for the user to describe the problem.
   - Three toggles (include file contents / include logs / include system info).
   - A "Generate Report" action that builds and renders a `BugReport`.
   - A scrollable/read-only preview of the generated report.
   - "Copy to Clipboard" and "Save to File" output actions (disabled until Generate is clicked).
3. **`SessionStateCollector`** wired from `MainWindow` to the dialog using getter lambdas.

---

## Dependencies

**Requires M1 (completed):** `PathSanitizer`

**Requires M2 (completed):** `BugReport`, `OpenFileEntry`, `ProbeTraceEntry`,
`EquationEntry`, `GraphWidgetEntry`, `ReportFormatter`

**Requires M3 (completed):** `SessionStateCollector`, `SessionState`

**Requires M4 (completed):** `LogCapture`, `LogSnapshot`

### Architectural Context

PyProbe's GUI runs in a single Qt process. `MainWindow` (≈1700 lines,
`pyprobe/gui/main_window.py`) is the central window. Menus are set up in
`_setup_theme_menu()`. The relevant live GUI objects are:

| Object | Attribute | Provides |
|---|---|---|
| `CodeViewer` | `self._code_viewer` | Open file info |
| `ProbeController` | `self._probe_controller` | Active probe info |
| `EquationManager` | `self._equation_manager` | Active equations |
| `ProbePanelContainer` | `self._probe_container` | Active graph widgets |

`SessionStateCollector` is constructed with lambdas delegating to these objects.
The dialog receives the collector and calls `collector.collect()` at report generation
time (not at dialog construction time).

---

## New Files

```
pyprobe/gui/report_bug_dialog.py        create — write tests FIRST
tests/gui/test_report_bug_dialog.py     create — write tests FIRST
```

## Modified Files

```
pyprobe/gui/main_window.py    add _setup_help_menu() + _show_report_bug_dialog()
```

---

## Tests to Write First

All tests below **must be failing** before any implementation is written.
All tests use `pytest-qt` (`qtbot` fixture).

### `tests/gui/test_report_bug_dialog.py`

```python
import pytest
from pathlib import Path
from unittest.mock import MagicMock, patch
from PyQt6.QtWidgets import QApplication
from pyprobe.gui.main_window import MainWindow
from pyprobe.gui.report_bug_dialog import ReportBugDialog
from pyprobe.report.session_snapshot import SessionStateCollector


# ── Helpers ───────────────────────────────────────────────────────────────────

def make_null_collector():
    """Return a SessionStateCollector with stub getters returning empty tuples."""
    return SessionStateCollector(
        file_getter=lambda: (),
        probe_getter=lambda: (),
        equation_getter=lambda: (),
        widget_getter=lambda: (),
    )


def make_dialog(qtbot, collector=None):
    """Construct and register a ReportBugDialog with qtbot."""
    if collector is None:
        collector = make_null_collector()
    dialog = ReportBugDialog(collector=collector)
    qtbot.addWidget(dialog)
    return dialog


# ── Menu integration tests ────────────────────────────────────────────────────

def test_help_menu_exists_in_main_window(qtbot):
    """MainWindow menu bar has a Help menu."""
    win = MainWindow()
    qtbot.addWidget(win)
    menu_titles = [a.text() for a in win.menuBar().actions()]
    assert any("help" in t.lower() for t in menu_titles)


def test_report_bug_action_in_help_menu(qtbot):
    """Help menu exposes a Report Bug action."""
    win = MainWindow()
    qtbot.addWidget(win)
    help_menu = next(
        a.menu() for a in win.menuBar().actions()
        if "help" in a.text().lower()
    )
    action_texts = [a.text().lower() for a in help_menu.actions()]
    assert any("report" in t or "bug" in t for t in action_texts)


def test_report_bug_action_opens_dialog(qtbot):
    """Triggering the Report Bug action opens a dialog window."""
    win = MainWindow()
    qtbot.addWidget(win)
    help_menu = next(
        a.menu() for a in win.menuBar().actions()
        if "help" in a.text().lower()
    )
    report_action = next(
        a for a in help_menu.actions()
        if "report" in a.text().lower() or "bug" in a.text().lower()
    )
    with patch.object(MainWindow, "_show_report_bug_dialog") as mock_show:
        report_action.trigger()
        mock_show.assert_called_once()


# ── Generate report tests ─────────────────────────────────────────────────────

def test_generate_report_populates_preview(qtbot):
    """Clicking Generate produces non-empty report text in the preview area."""
    dialog = make_dialog(qtbot)
    dialog._trigger_generate()  # internal method; drives the Generate action
    preview_text = dialog._get_preview_text()  # internal accessor for test
    assert isinstance(preview_text, str)
    assert len(preview_text) > 0


def test_generate_report_contains_user_description(qtbot):
    """Description entered by the user appears verbatim in the generated report."""
    dialog = make_dialog(qtbot)
    dialog._set_description("Probe panel shows wrong scale after zoom")
    dialog._trigger_generate()
    assert "Probe panel shows wrong scale after zoom" in dialog._get_preview_text()


# ── Output action state tests ─────────────────────────────────────────────────

def test_output_actions_disabled_before_generate(qtbot):
    """Copy and Save output actions are unavailable before Generate has been clicked."""
    dialog = make_dialog(qtbot)
    assert not dialog._copy_action_enabled()
    assert not dialog._save_action_enabled()


def test_output_actions_enabled_after_generate(qtbot):
    """Copy and Save output actions become available after Generate is clicked."""
    dialog = make_dialog(qtbot)
    dialog._trigger_generate()
    assert dialog._copy_action_enabled()
    assert dialog._save_action_enabled()


# ── Copy to clipboard test ────────────────────────────────────────────────────

def test_copy_to_clipboard_writes_report_text(qtbot):
    """Clipboard contains the generated report text after Copy is activated."""
    dialog = make_dialog(qtbot)
    dialog._set_description("clipboard test")
    dialog._trigger_generate()
    dialog._trigger_copy()
    clipboard_text = QApplication.clipboard().text()
    assert "clipboard test" in clipboard_text


# ── PII sanitization test ─────────────────────────────────────────────────────

def test_report_sanitizes_paths_in_output(qtbot):
    """Any home-directory path that enters the report appears as <USER_HOME>."""
    from pyprobe.report.report_model import OpenFileEntry
    home = str(Path.home())
    collector = SessionStateCollector(
        file_getter=lambda: [
            OpenFileEntry(
                path=f"{home}/repos/pyprobe/examples/demo.py",
                is_probed=True, is_executed=True, has_unsaved=False,
            )
        ],
        probe_getter=lambda: (),
        equation_getter=lambda: (),
        widget_getter=lambda: (),
    )
    dialog = make_dialog(qtbot, collector=collector)
    dialog._trigger_generate()
    output = dialog._get_preview_text()
    assert home not in output
    assert "<USER_HOME>" in output


# ── Conditional section toggle tests ─────────────────────────────────────────

def test_environment_section_toggled_by_sysinfo_option(qtbot):
    """Environment section appears when sysinfo option is enabled; absent when disabled."""
    dialog = make_dialog(qtbot)

    dialog._set_sysinfo_enabled(True)
    dialog._trigger_generate()
    output_with = dialog._get_preview_text()

    dialog._set_sysinfo_enabled(False)
    dialog._trigger_generate()
    output_without = dialog._get_preview_text()

    # When enabled, some environment value must appear (e.g., a version string)
    assert any(key in output_with for key in ("python", "PyProbe", "pyprobe", "platform", "Qt"))
    # When disabled, the same values must not appear via the environment section
    # (they may appear elsewhere, so we check the environment header is absent)
    assert output_with != output_without


def test_logs_section_toggled_by_logs_option(qtbot, tmp_path):
    """Logs section appears when logs option is enabled; absent when disabled."""
    dialog = make_dialog(qtbot)

    dialog._set_logs_enabled(True)
    dialog._trigger_generate()
    output_with = dialog._get_preview_text()

    dialog._set_logs_enabled(False)
    dialog._trigger_generate()
    output_without = dialog._get_preview_text()

    assert output_with != output_without


def test_file_contents_section_toggled_by_files_option(qtbot):
    """File contents appear in the report when the include-files option is enabled."""
    from pyprobe.report.report_model import OpenFileEntry
    collector = SessionStateCollector(
        file_getter=lambda: [
            OpenFileEntry(
                path="/tmp/demo.py", is_probed=True, is_executed=True,
                has_unsaved=False, contents="x = np.zeros(1024)\n",
            )
        ],
        probe_getter=lambda: (),
        equation_getter=lambda: (),
        widget_getter=lambda: (),
    )
    dialog = make_dialog(qtbot, collector=collector)

    dialog._set_files_enabled(True)
    dialog._trigger_generate()
    output_with = dialog._get_preview_text()

    dialog._set_files_enabled(False)
    dialog._trigger_generate()
    output_without = dialog._get_preview_text()

    assert "x = np.zeros(1024)" in output_with
    assert "x = np.zeros(1024)" not in output_without


# ── Resilience test ───────────────────────────────────────────────────────────

def test_dialog_does_not_crash_with_no_open_file(qtbot):
    """Generate Report completes without error when no file is loaded."""
    dialog = make_dialog(qtbot)  # null collector returns no files
    dialog._trigger_generate()
    assert len(dialog._get_preview_text()) >= 0  # no exception thrown


# ── Regression guard ──────────────────────────────────────────────────────────

def test_existing_probe_flow_unaffected(qtbot):
    """Opening MainWindow is unaffected by the Help menu addition."""
    win = MainWindow()
    qtbot.addWidget(win)
    # MainWindow must still expose the View menu and its existing actions
    view_menu = next(
        a.menu() for a in win.menuBar().actions()
        if "view" in a.text().lower()
    )
    assert view_menu is not None
```

### Test Helper API Convention

`ReportBugDialog` must expose these internal test-helper methods. They are
*not* part of the public dialog API but are required for testability:

| Method | Purpose |
|---|---|
| `_trigger_generate()` | Simulates clicking the Generate Report action |
| `_get_preview_text() -> str` | Returns the current preview text |
| `_set_description(text: str)` | Programmatically sets the description field |
| `_copy_action_enabled() -> bool` | Returns whether Copy is currently available |
| `_save_action_enabled() -> bool` | Returns whether Save is currently available |
| `_trigger_copy()` | Simulates clicking Copy to Clipboard |
| `_set_sysinfo_enabled(flag: bool)` | Sets the include-system-info toggle |
| `_set_logs_enabled(flag: bool)` | Sets the include-logs toggle |
| `_set_files_enabled(flag: bool)` | Sets the include-file-contents toggle |

These methods keep tests independent of widget hierarchy and label text while
verifying the correct behavioral outcomes.

---

## Implementation Scope

### `pyprobe/gui/report_bug_dialog.py`

`ReportBugDialog(QDialog)` constructor accepts:
- `collector: SessionStateCollector` — used to call `collect()` at generate time.

UI elements required (exact layout is an implementation detail):
- Text area for user description.
- Three independent toggles: include file contents, include logs, include system info.
- A "Generate Report" action (button or menu item).
- A read-only preview area displaying the rendered report.
- "Copy to Clipboard" output action (disabled until Generate has been called).
- "Save to File" output action (disabled until Generate has been called).

`_trigger_generate()` logic:
1. Call `self._collector.collect()` to get a `SessionState` snapshot.
2. Optionally call `LogCapture.capture()` if logs are enabled.
3. Optionally call `EnvironmentCollector.collect()` if sysinfo is enabled.
4. Build a `BugReport` with the description and conditionally populated sections.
5. Render via `ReportFormatter().render(report)`.
6. Populate preview; enable Copy and Save actions.

### `pyprobe/gui/main_window.py` changes

Add private method `_setup_help_menu()`:
```python
def _setup_help_menu(self) -> None:
    help_menu = self.menuBar().addMenu("Help")
    report_action = help_menu.addAction("Report Bug")
    report_action.triggered.connect(self._show_report_bug_dialog)
```

Add private method `_show_report_bug_dialog()`:
```python
def _show_report_bug_dialog(self) -> None:
    from pyprobe.gui.report_bug_dialog import ReportBugDialog
    from pyprobe.report.session_snapshot import SessionStateCollector
    collector = SessionStateCollector(
        file_getter=lambda: self._code_viewer.open_file_entries(),
        probe_getter=lambda: self._probe_controller.probe_trace_entries(),
        equation_getter=lambda: self._equation_manager.equation_entries(),
        widget_getter=lambda: self._probe_container.graph_widget_entries(),
    )
    dialog = ReportBugDialog(collector=collector, parent=self)
    dialog.exec()
```

Call `_setup_help_menu()` at the end of `__init__`, after `_setup_theme_menu()`.

**Note:** `CodeViewer.open_file_entries()`, `ProbeController.probe_trace_entries()`,
`EquationManager.equation_entries()`, and `ProbePanelContainer.graph_widget_entries()`
are new helper methods to be added to their respective classes as part of this milestone.
Each returns an iterable of the corresponding report model type.

---

## Regression Guarantees

These 14 tests are **permanent**. All future milestones and future development must
pass them:

| Test | What It Guards |
|---|---|
| `test_help_menu_exists_in_main_window` | Help menu always present |
| `test_report_bug_action_in_help_menu` | Report Bug always accessible |
| `test_report_bug_action_opens_dialog` | Menu action triggers dialog |
| `test_generate_report_populates_preview` | Generate always produces output |
| `test_generate_report_contains_user_description` | Description verbatim in output |
| `test_output_actions_disabled_before_generate` | Copy/Save gated on Generate |
| `test_output_actions_enabled_after_generate` | Copy/Save enabled post-Generate |
| `test_copy_to_clipboard_writes_report_text` | Clipboard gets full report text |
| `test_report_sanitizes_paths_in_output` | No PII in output ever |
| `test_environment_section_toggled_by_sysinfo_option` | Sysinfo toggle works |
| `test_logs_section_toggled_by_logs_option` | Logs toggle works |
| `test_file_contents_section_toggled_by_files_option` | File contents toggle works |
| `test_dialog_does_not_crash_with_no_open_file` | Resilience to empty state |
| `test_existing_probe_flow_unaffected` | No regression in existing flow |

---

## Non-Functional Constraints

- **Session state collected at generate time**, not at dialog construction time.
  `collector.collect()` is called when the user clicks Generate, not when the dialog
  opens. This ensures the snapshot reflects the state at the moment of generation.
- **Logs are opt-in.** `LogCapture.capture()` is called only when the logs toggle
  is enabled.
- **File contents are opt-in.** `OpenFileEntry.contents` is populated only when the
  file-contents toggle is enabled.
- **No file contents by default.** Default state of the file-contents toggle is off.
- **Large file truncation.** `ReportFormatter` is constructed with `max_file_bytes=50*1024`.
  This is enforced automatically by the formatter.

---

## Completion Checklist

- [ ] `tests/gui/test_report_bug_dialog.py` written; all 14 tests confirmed **failing** before implementation
- [ ] `pyprobe/gui/report_bug_dialog.py` implemented with all test helper methods
- [ ] `pyprobe/gui/main_window.py` updated (`_setup_help_menu`, `_show_report_bug_dialog`)
- [ ] Helper methods added to `CodeViewer`, `ProbeController`, `EquationManager`,
      `ProbePanelContainer` to expose report model entries
- [ ] All 14 new tests pass
- [ ] `python run_tests.py` fully green (all existing tests + M1–M4 tests still pass)
- [ ] No `# noqa` / `# type: ignore` without written justification
