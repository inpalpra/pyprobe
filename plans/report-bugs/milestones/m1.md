# Milestone 1 — PathSanitizer & EnvironmentCollector

## Overview

This is the first milestone of the Report Bug feature. It produces two pure-logic
utility modules with no Qt or GUI dependency. These utilities underpin every later
milestone: all report output routes through `PathSanitizer`, and `EnvironmentCollector`
populates the Environment section of every generated bug report.

---

## Guiding Principles

- **Tests first, implementation second.** Write all tests listed below, confirm every
  one is **failing**, then write the implementation that makes them pass.
- **Zero regression tolerance.** `python run_tests.py` must be fully green at the end
  of this milestone. No existing tests may break.
- **Lock semantics, not cosmetics.** Tests protect behavioral contracts — correct
  substitution, correct keys, correct fallbacks — not internal implementation details.
- **Permanent regression suite.** Every test written here becomes a permanent guard
  for all future milestones and all future development.

---

## Goal

Implement:

1. **`PathSanitizer`** — replaces the user's home-directory path with the literal
   `<USER_HOME>` in any string. Prevents PII from leaking into generated bug reports.

2. **`EnvironmentCollector`** — gathers system environment data: Python version,
   PyProbe version, OS platform, Qt version, installed plugin list, and optionally
   the git commit hash. Returns a plain `dict`.

---

## Dependencies

None. This milestone has no dependency on any other milestone or any GUI code.

---

## New Files

```
pyprobe/report/__init__.py        create (empty)
pyprobe/report/sanitizer.py       create
pyprobe/report/environment.py     create
tests/report/__init__.py          create (empty)
tests/report/test_sanitizer.py    create — write tests FIRST
tests/report/test_environment.py  create — write tests FIRST
```

Add `report` as a new suite in `run_tests.py`, pointing to `tests/report/`.

---

## Tests to Write First

All tests below **must be failing** before any implementation is written.

### `tests/report/test_sanitizer.py`

```python
from pathlib import Path
import os
from pyprobe.report.sanitizer import PathSanitizer


def test_sanitize_unix_home_in_path():
    """Absolute Unix home path is replaced with <USER_HOME>."""
    home = str(Path.home())
    result = PathSanitizer.sanitize(f"{home}/repos/pyprobe/script.py")
    assert "<USER_HOME>" in result
    assert home not in result


def test_sanitize_windows_home_in_path():
    """Home path replacement works on all platforms regardless of separator style."""
    home = str(Path.home())
    text = f"File at {home}\\Documents\\file.py"
    result = PathSanitizer.sanitize(text)
    assert home not in result


def test_sanitize_does_not_alter_non_home_paths():
    """Paths outside the home directory are left unchanged."""
    text = "/tmp/pyprobe_debug.log"
    assert PathSanitizer.sanitize(text) == text


def test_sanitize_multiple_occurrences_in_one_string():
    """All occurrences of the home path in a multi-line string are replaced."""
    home = str(Path.home())
    text = f"File: {home}/a.py\nOther: {home}/b.py"
    result = PathSanitizer.sanitize(text)
    assert result.count("<USER_HOME>") == 2
    assert home not in result


def test_sanitize_empty_string_returns_empty():
    """Empty input returns empty output."""
    assert PathSanitizer.sanitize("") == ""


def test_sanitize_path_with_tilde_expansion():
    """Paths expanded from ~ are sanitized."""
    expanded = os.path.expanduser("~/repos/pyprobe")
    result = PathSanitizer.sanitize(expanded)
    assert str(Path.home()) not in result


def test_sanitize_preserves_relative_paths():
    """Relative paths are not modified."""
    text = "examples/dsp_demo.py"
    assert PathSanitizer.sanitize(text) == text


def test_sanitize_in_traceback_string():
    """Home path embedded inside a mock traceback string is sanitized."""
    home = str(Path.home())
    traceback = (
        f'  File "{home}/repos/pyprobe/pyprobe/core/tracer.py", line 42, in trace\n'
        f'    raise ValueError("bad")\n'
        f'ValueError: bad'
    )
    result = PathSanitizer.sanitize(traceback)
    assert home not in result
    assert "<USER_HOME>" in result
```

### `tests/report/test_environment.py`

```python
import time
import pytest
from pyprobe.report.environment import EnvironmentCollector


def test_environment_contains_python_version():
    """Collected env has 'python_version' key with a non-empty string."""
    env = EnvironmentCollector.collect()
    assert "python_version" in env
    assert isinstance(env["python_version"], str)
    assert len(env["python_version"]) > 0


def test_environment_contains_pyprobe_version():
    """Collected env has 'pyprobe_version' matching pyprobe.__version__."""
    import pyprobe
    env = EnvironmentCollector.collect()
    assert "pyprobe_version" in env
    assert env["pyprobe_version"] == pyprobe.__version__


def test_environment_contains_platform():
    """Collected env has 'platform' key with a non-empty string."""
    env = EnvironmentCollector.collect()
    assert "platform" in env
    assert isinstance(env["platform"], str)
    assert len(env["platform"]) > 0


def test_environment_contains_qt_version():
    """Collected env has 'qt_version' key with a non-empty string."""
    env = EnvironmentCollector.collect()
    assert "qt_version" in env
    assert isinstance(env["qt_version"], str)
    assert len(env["qt_version"]) > 0


def test_environment_contains_plugin_list():
    """Collected env has 'plugins' as a list (may be empty)."""
    env = EnvironmentCollector.collect()
    assert "plugins" in env
    assert isinstance(env["plugins"], list)


def test_environment_git_hash_is_string_or_unknown():
    """git_commit_hash is a non-empty string or the literal 'unknown'."""
    env = EnvironmentCollector.collect()
    assert "git_commit_hash" in env
    value = env["git_commit_hash"]
    assert isinstance(value, str)
    assert len(value) > 0


def test_environment_paths_are_sanitized():
    """Any home-directory path in the env snapshot is replaced with <USER_HOME>."""
    from pathlib import Path
    env = EnvironmentCollector.collect()
    full_text = str(env)
    assert str(Path.home()) not in full_text


@pytest.mark.performance
def test_environment_collection_is_fast():
    """EnvironmentCollector.collect() completes in under 2 seconds.

    Marked @pytest.mark.performance — exclude in constrained CI with:
        pytest -m 'not performance'
    """
    start = time.monotonic()
    EnvironmentCollector.collect()
    elapsed = time.monotonic() - start
    assert elapsed < 2.0, f"collect() took {elapsed:.2f}s, expected < 2.0s"
```

---

## Implementation Scope

### `pyprobe/report/sanitizer.py`

```python
from pathlib import Path


class PathSanitizer:
    """Replaces user home-directory paths with <USER_HOME> in any string."""

    PLACEHOLDER = "<USER_HOME>"

    @classmethod
    def sanitize(cls, text: str) -> str:
        """Return text with all occurrences of the user home dir replaced."""
        home = str(Path.home())
        return text.replace(home, cls.PLACEHOLDER)
```

### `pyprobe/report/environment.py`

`EnvironmentCollector.collect() -> dict` must gather:

| Key | Source | Fallback |
|---|---|---|
| `python_version` | `sys.version` | — |
| `pyprobe_version` | `pyprobe.__version__` | — |
| `platform` | `platform.system()` | — |
| `qt_version` | `PyQt6.QtCore.QT_VERSION_STR` (lazy import) | `"unknown"` |
| `plugins` | `PluginRegistry.instance()` plugin names | `[]` |
| `git_commit_hash` | `subprocess` `git rev-parse --short HEAD` | `"unknown"` |

Apply `PathSanitizer.sanitize()` to the string representation of collected data
before returning. Wrap all external calls (`subprocess`, Qt import, plugin registry)
in `try/except` with safe fallbacks.

**Critical constraint:** `PyQt6` must be imported lazily (inside the method body)
so that `tests/report/` can run without a display or Qt installation.

### `run_tests.py`

Add `report` to the list of available suites, pointing to `tests/report/`.

---

## Regression Guarantees

These 16 tests are **permanent**. All future milestones and all future development
must pass them:

| Test | What It Guards |
|---|---|
| `test_sanitize_unix_home_in_path` | Home replacement on Unix |
| `test_sanitize_windows_home_in_path` | Home replacement on Windows |
| `test_sanitize_does_not_alter_non_home_paths` | No false positives |
| `test_sanitize_multiple_occurrences_in_one_string` | All occurrences replaced |
| `test_sanitize_empty_string_returns_empty` | Empty-string edge case |
| `test_sanitize_path_with_tilde_expansion` | Tilde-expanded paths sanitized |
| `test_sanitize_preserves_relative_paths` | Relative paths unmodified |
| `test_sanitize_in_traceback_string` | Sanitization works inside tracebacks |
| `test_environment_contains_python_version` | Key always present |
| `test_environment_contains_pyprobe_version` | Version matches `__version__` |
| `test_environment_contains_platform` | Key always present |
| `test_environment_contains_qt_version` | Key always present |
| `test_environment_contains_plugin_list` | Returns `list`, not other type |
| `test_environment_git_hash_is_string_or_unknown` | Never `None` or empty |
| `test_environment_paths_are_sanitized` | No PII in env snapshot |
| `test_environment_collection_is_fast` *(performance)* | Completes under 2 s |

---

## Non-Functional Constraints

- **No Qt import at module load time.** `environment.py` must import `PyQt6` lazily
  so tests run without a display.
- **No GUI dependency.** Neither `sanitizer.py` nor `environment.py` may import
  anything from `pyprobe.gui`.
- **Subprocess failures are safe.** The git hash call must be wrapped in `try/except`
  with `"unknown"` fallback.
- **Plugin registry failures are safe.** If `PluginRegistry.instance()` raises,
  fall back to `[]`.

---

## Completion Checklist

- [ ] `tests/report/test_sanitizer.py` written; all 8 tests confirmed **failing** before implementation
- [ ] `tests/report/test_environment.py` written; all 8 tests confirmed **failing** before implementation
- [ ] `pyprobe/report/__init__.py` created (empty)
- [ ] `tests/report/__init__.py` created (empty)
- [ ] `pyprobe/report/sanitizer.py` implemented
- [ ] `pyprobe/report/environment.py` implemented (lazy Qt import, safe fallbacks)
- [ ] `run_tests.py` updated with `report` suite
- [ ] All 16 new tests pass (8 sanitizer + 7 env non-performance + 1 performance)
- [ ] `python run_tests.py` fully green (all existing tests still pass)
- [ ] No `# noqa` / `# type: ignore` without written justification
